<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link href="../bower_components/polymer/polymer-element.html" rel="import">
<link href="../bower_components/google-map/google-map.html" rel="import">
<link href="../bower_components/google-map/google-map-marker.html" rel="import">
<link href="../bower_components/google-map-markerclusterer/google-map-markerclusterer.html" rel="import">
<link href="../bower_components/bottom-sheet/bottom-sheet.html" rel="import">
<link href="../bower_components/paper-item/paper-item.html" rel="import">
<link href="../bower_components/iron-icon/iron-icon.html" rel="import">
<link href="../bower_components/iron-image/iron-image.html" rel="import">
<link href="../bower_components/geo-location/geo-location.html" rel="import">
<link href="../bower_components/skeleton-carousel/skeleton-carousel.html" rel="import">
<link href="shared-styles.html" rel="import">

<dom-module id="ivd-map">
	<template>
		<style include="shared-styles">
			:host {
				display: block;
				margin: 0;
				height: calc(100vh - 64px);
			}
			:host[mobile] {
				--bottom-sheet-max-height: 60%;
				--bottom-sheet-max-width: 50%;
			}
			iron-image {
				--iron-image-width: 300px;
				--iron-image-height: 300px;
			}
			cosmoz-image-viewer {

			}

			google-map {
				width: 100%;
				position: fixed;
			}

			@media (min-width: 640px) {
				google-map {
					width: calc(100% - 256px);
				}
			}
		</style>
		<google-map-markerclusterer map="[[map]]" markers="[[markers]]"
									minimum-cluster-size="4"></google-map-markerclusterer>
		<geo-location watch-pos high-accuracy latitude="{{latitude}}" longitude="{{longitude}}"></geo-location>
		<google-map api-key="AIzaSyCWXoAx0CvojqwW_3mzkccc0wfbUXgXW4k"
					debug
					fit-to-markers
					id="map"
					latitude="48.861071"
					longitude="2.350494"
					map="{{map}}"
					click-events
					drag-events
					on-google-map-ready="_fetchData"
					on-google-map-dragstart="_closeSheet"
					on-google-map-click="_closeSheet"
					style$="height: [[height]]px">
			<google-map-marker animation="DROP"
							   icon="[[resolveUrl('../images/userPosition.svg')]]"
							   latitude="[[latitude]]"
							   longitude="[[longitude]]"></google-map-marker>
			<template as="invader" is="dom-repeat" items="{{invaders}}">
				<google-map-marker animation="DROP"
								   icon="[[resolveUrl('../images/marker.png')]]"
								   latitude="[[invader.latitude]]"
								   longitude="[[invader.longitude]]"
								   click-events
								   on-google-map-marker-click="_markerClicked"
								   on-marker-changed="_clusterMarker"
								   slot="markers">
				</google-map-marker>
			</template>
		<bottom-sheet id="sheet" class="center-bottom" label="[[currentInvader.name]]" no-cancel-on-outside-click>
			<skeleton-carousel dots="[[!mobile]]" nav="[[!mobile]]" loop auto direction="[[getDirection(mobile)]]">
				<template as="photoUrl" is="dom-repeat" items="[[currentInvader.url]]">
					<iron-image placeholder="[[resolveUrl('../images/icons/icon-192x192.png')]]"
								src="[[getUrl(photoUrl)]]"
								data-src="[[getUrl(photoUrl)]]"
								sizing="cover"
								preload
								fade>
					</iron-image>
				</template>
			</skeleton-carousel>
			<paper-item>[[currentInvader.address]]</paper-item>
			<paper-item>lat:[[currentInvader.latitude]] - lon:[[currentInvader.longitude]]</paper-item>
		</bottom-sheet>
		</google-map>
	</template>

	<script>
		class IVDMap extends Polymer.Element {
			static get is() {
				return 'ivd-map';
			}

			static get properties() {
				return {
					invaders: {
						type: Array,
						value: [],
						notify: true
					},
					markers: {
						type: Array,
						value: [],
						notify: true
					},
					mobile: Boolean,
					currentInvader: Object,
					map: Object
				};
			}

			connectedCallback() {
				super.connectedCallback();
			}

			_fetchData() {
				this.getMapStyles();
				this.height = window.innerHeight - 64;
				fetch('locations.json').then(x => x.json().then(res => {
					res.forEach(x => {
						x.latitude = Number(x.latitude);
						x.longitude = Number(x.longitude);
						this.push('invaders', x);
					});
				})).catch(x => x.json().then(res => console.log(res)))
			}

			_clusterMarker(e) {
				this.push('markers', e.detail.value);
			}

			_markerClicked(e) {
				console.log(e);
				this.set('currentInvader', e.model.__data.invader);
				if (!this.$.sheet.opened) {
					this.$.sheet.open();
				} else {
					e.stopPropagation();
					e.preventDefault();
				}
			}

			getDirection(mobile) {
				return mobile ? 'vertical' : 'horizontal';
			}

			getUrl(name) {
				return this.resolveUrl(`/images/invaders/${name}`);
			}

			_closeSheet(e) {
				this.$.sheet.close();
			}

			getMapStyles() {
				let hours = new Date()
					.getHours();
				const isDayTime = hours > 7 && hours < 19;
				fetch(this.resolveUrl('../mapStyles.json'))
					.then(e => e.json()
						.then(e => {
							console.log(e);
							this.height = window.innerHeight - 64;
							if (this.$.map && this.$.map.map) {
								this.$.map.map.setOptions({
									styles: isDayTime ? e.day : e.night
								});
							} else {
								this.set('mapStyles', isDayTime ? e.day : e.night);
							}
						}))
					.catch(error => {
						console.warn(error);
					});
			}
		}

		window.customElements.define(IVDMap.is, IVDMap);
	</script>
</dom-module>
